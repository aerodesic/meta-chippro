#@TYPE: Machine
#@NAME: C.H.I.P. board
#@DESCRIPTION: Machine configuration for C.H.I.P. board

MACHINE_EXTRA_RRECOMMENDS = " kernel-modules"
MACHINE_ESSENTIAL_EXTRA_RDEPENDS = " kernel-image kernel-devicetree"

EXTRA_IMAGEDEPENDS += "u-boot sunxi-tools-native android-tools-native"

# TARGET_CFLAGS += "-v"

DEFAULTTUNE ?= "cortexa8t-neon"
include conf/machine/include/tune-cortexa8.inc


SERIAL_CONSOLE = "115200 ttyS0"

PREFERRED_PROVIDER_virtual/kernel ?= "linux-chippro"
PREFERRED_PROVIDER_u-boot ?= "u-boot-chip"

KERNEL_IMAGETYPE = "zImage"
KERNEL_DEVICETREE = "ntc-gr8-crumb.dtb"

SPL_BINARY = "u-boot-sunxi-with-spl.bin"
# SPL_BINARY = "sunxi-spl.bin"
SPL_ECC_BINARY = "sunxi-spl-with-ecc.bin"
# UBOOT_BINARY = "u-boot-dtb.bin"
UBOOT_BINARY = "u-boot-sunxi-padded.bin"
UBOOT_MACHINE = "CHIP_pro_defconfig"
MAX_UBI_SIZE = "(512 << 10)"
NAND_ERASE_BLOCK_SIZE = "262144"

MACHINE_FEATURES = "usbgadget usbhost wifi"

# Include wifi modules and firmware
MACHINE_EXTRA_RRECOMMENDS += "kernel-module-r8723bs rtl8723bs"

# IMAGE_FSTYPES += "ubi"
# UBI_VOLNAME = "rootfs"
CHIP_UBI_PAGE_SIZE = "4096"
MKUBIFS_ARGS = "--min-io-size ${CHIP_UBI_PAGE_SIZE} --leb-size 258048 --max-leb-cnt 2000"
UBINIZE_ARGS = "--min-io-size ${CHIP_UBI_PAGE_SIZE} --peb-size 262144 --sub-page-size 1024"

ENV_IMAGE_SIZE = "0x400000"

IMAGE_FSTYPES += "ubimultivol"
# IMAGE_FSTYPES += "ubi"

export UBIVOL_NAMES		= "env env_backup rootfs_a rootfs_b fdt_a fdt_b kernel_a data"

export UBIVOL_IMAGE_env		= "uboot-env.bin"
export UBIVOL_TYPE_env		= "dynamic"

# Duplicate of env
export UBIVOL_IMAGE_env_backup	= "uboot-env.bin"
export UBIVOL_TYPE_env_backup	= "dynamic"

export UBIVOL_IMAGE_rootfs_a	= "<rootfs-ro>"
export UBIVOL_TYPE_rootfs_a	= "dynamic"
export UBIVOL_SIZE_rootfs_a	= "100MiB"

# Duplicate of rootfs_a
export UBIVOL_IMAGE_rootfs_b	= "<rootfs-ro>"
export UBIVOL_TYPE_rootfs_b	= "dynamic"
export UBIVOL_SIZE_rootfs_b	= "100MiB"

export UBIVOL_IMAGE_fdt_a	= "${KERNEL_DEVICETREE}"
export UBIVOL_TYPE_fdt_a	= "static"

# Duplicate of fdt_a
export UBIVOL_IMAGE_fdt_b	= "${KERNEL_DEVICETREE}"
export UBIVOL_TYPE_fdt_b	= "static"

export UBIVOL_IMAGE_kernel_a	= "zImage"
export UBIVOL_TYPE_kernel_a	= "static"

# Duplicate of kernel_a
export UBIVOL_IMAGE_kernel_b	= "zImage"
export UBIVOL_TYPE_kernel_b	= "static"

export UBIVOL_IMAGE_data	= "<rootfs-rw>"
export UBIVOL_TYPE_data		= "dynamic"
export UBIVOL_FLAGS_data	= "autoresize"

# Define the elements in the r/w data
export UBIVOL_ROOTFS_DATA	= "etc/dnsmasq.con etc/ssh var home"
export UBIVOL_SPARSE		= "yes"

